<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FinanceFlow Ultra v10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --m-bg: #000000; --m-card: #1c1c1e; --m-blue: #0a84ff; }
        body { background-color: var(--m-bg); color: white; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .page { display: none; height: 100vh; overflow-y: auto; padding-bottom: 120px; -webkit-overflow-scrolling: touch; }
        .page.active { display: block; }

        .glass-card { background: var(--m-card); border-radius: 28px; border: 0.5px solid rgba(255,255,255,0.1); }
        .nav-bar { background: rgba(20, 20, 22, 0.9); backdrop-filter: saturate(180%) blur(20px); border-top: 0.5px solid rgba(255,255,255,0.1); padding-bottom: env(safe-area-inset-bottom); }
        
        /* 格式化輸入框容器 */
        .fmt-input-container { position: relative; width: 100%; display: flex; align-items: center; }
        .fmt-display { position: absolute; left: 0; pointer-events: none; width: 100%; color: white; }
        .real-input { background: transparent; color: transparent; caret-color: white; width: 100%; outline: none; }

        .btn-action { background: linear-gradient(145deg, #2c2c2e, #1a1a1c); border: 1px solid rgba(255,255,255,0.15); color: #efeff4; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .btn-action:active { transform: scale(0.96); opacity: 0.8; }
        .cat-active { background: var(--m-blue) !important; color: #fff !important; font-weight: bold; }
        .month-chip { flex: 0 0 auto; padding: 10px 20px; border-radius: 14px; background: #2c2c2e; color: #8e8e93; font-size: 14px; }
        .month-chip.active { background: #3a3a3c; color: #fff; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <section id="page-add" class="page active px-6">
        <header class="mb-6 pt-12">
            <p class="text-zinc-500 text-[11px] font-bold tracking-widest uppercase mb-1">本月生活餘額 (VND)</p>
            <h1 class="text-6xl font-black tracking-tighter" id="home-balance">0</h1>
            <div class="flex gap-3 mt-6">
                <div class="flex-1 bg-zinc-900/80 p-4 rounded-3xl border border-white/5">
                    <p class="text-[10px] text-zinc-500 font-bold mb-1">台股待投</p>
                    <p class="text-lg font-bold text-blue-400" id="home-tw">0</p>
                </div>
                <div class="flex-1 bg-zinc-900/80 p-4 rounded-3xl border border-white/5">
                    <p class="text-[10px] text-zinc-500 font-bold mb-1">美股待投</p>
                    <p class="text-lg font-bold text-indigo-400" id="home-us">0</p>
                </div>
            </div>
        </header>

        <div class="glass-card p-6 space-y-6 mb-4">
            <div class="fmt-input-container h-20 border-b border-zinc-800">
                <div id="fmt-amt" class="fmt-display text-6xl font-bold">0</div>
                <input type="number" id="amt" class="real-input text-6xl font-bold" inputmode="decimal">
                <select id="cur" class="absolute right-0 bg-zinc-800 text-xs font-black px-3 py-1 rounded-full border border-zinc-700">
                    <option value="VND">VND</option>
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div class="grid grid-cols-4 gap-2" id="cat-grid"></div>

            <div class="space-y-3">
                <div class="w-full bg-zinc-800/40 rounded-2xl border border-white/5 flex items-center px-4 overflow-hidden">
                    <i class="fa-regular fa-calendar text-zinc-500 mr-3"></i>
                    <input type="date" id="entry-date" class="bg-transparent py-4 text-white w-full outline-none text-lg">
                </div>
                <div class="w-full bg-zinc-800/40 rounded-2xl border border-white/5 flex items-center px-4 overflow-hidden">
                    <i class="fa-solid fa-pen-to-square text-zinc-500 mr-3"></i>
                    <input type="text" id="note" placeholder="備註..." class="bg-transparent py-4 text-white w-full outline-none text-lg">
                </div>
            </div>

            <button onclick="handleAdd()" class="w-full btn-action py-5 rounded-[22px] font-bold text-xl mt-2">確認紀錄</button>
            <div class="h-32"></div>
        </div>
    </section>

    <section id="page-chart" class="page px-6">
        <h2 class="text-3xl font-bold mb-6 pt-12">支出佔比</h2>
        <div class="flex overflow-x-auto gap-3 mb-6 no-scrollbar" id="month-picker"></div>
        
        <div class="glass-card p-6 mb-4 text-center">
            <div style="height: 250px;"><canvas id="mainChart"></canvas></div>
            <div class="mt-6 border-t border-zinc-800 pt-4">
                <p class="text-zinc-500 text-xs font-bold mb-1 uppercase">該月總支出</p>
                <p class="text-3xl font-black text-white" id="month-total">0</p>
            </div>
        </div>

        <div id="cat-ratios" class="grid grid-cols-2 gap-3 mb-6 text-[11px]"></div>
        <div id="history-list" class="space-y-4 pb-40"></div>
    </section>

    <section id="page-set" class="page px-6">
        <h2 class="text-3xl font-bold mb-8 pt-12">預算規劃</h2>
        <div class="grid grid-cols-4 gap-2 mb-8" id="matrix-grid"></div>
        
        <div id="edit-box" class="glass-card p-6 hidden mb-6">
            <h3 class="font-bold text-blue-500 mb-4" id="edit-title">編輯預算</h3>
            <div class="space-y-4">
                <div class="fmt-input-container bg-zinc-900 p-4 rounded-2xl border border-white/5">
                    <div id="fmt-in-life" class="fmt-display ml-4 font-bold text-lg">0</div>
                    <input type="number" id="in-life" class="real-input ml-4 font-bold text-lg" placeholder="生活費">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="fmt-input-container bg-zinc-900 p-4 rounded-2xl border border-white/5">
                        <div id="fmt-in-tw" class="fmt-display ml-4 font-bold text-sm">0</div>
                        <input type="number" id="in-tw" class="real-input ml-4 font-bold text-sm">
                    </div>
                    <div class="fmt-input-container bg-zinc-900 p-4 rounded-2xl border border-white/5">
                        <div id="fmt-in-us" class="fmt-display ml-4 font-bold text-sm">0</div>
                        <input type="number" id="in-us" class="real-input ml-4 font-bold text-sm">
                    </div>
                </div>
                <button onclick="saveBudget()" class="w-full bg-blue-600 py-4 rounded-2xl font-black">儲存設定</button>
            </div>
        </div>

        <div class="space-y-3 pb-40">
            <button onclick="exportData()" class="w-full py-4 rounded-2xl bg-zinc-900 text-zinc-500 font-bold text-sm border border-white/5">
                <i class="fa-solid fa-file-export mr-2"></i>匯出 JSON 備份
            </button>
            <button onclick="alert('請複製下方 JSON 至 Notion 表格')" class="w-full py-4 rounded-2xl bg-zinc-900 text-zinc-500 font-bold text-sm border border-white/5">
                <i class="fa-solid fa-paper-plane mr-2"></i>同步至 Notion
            </button>
        </div>
    </section>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 h-24 flex justify-around items-center px-12 z-[100]">
        <button onclick="go('add')" id="nav-add" class="nav-btn active text-3xl"><i class="fa-solid fa-plus-circle"></i></button>
        <button onclick="go('chart')" id="nav-chart" class="nav-btn text-3xl"><i class="fa-solid fa-chart-pie"></i></button>
        <button onclick="go('set')" id="nav-set" class="nav-btn text-3xl"><i class="fa-solid fa-sliders"></i></button>
    </nav>

    <script>
        const CATS = ['飲食', '交通', '購物', '娛樂', '住宿', '台股', '美股', '其他'];
        let selCat = CATS[0], viewM = new Date().getMonth(), editM = null, chartObj = null;
        let state = JSON.parse(localStorage.getItem('fin_v10')) || {
            records: [], budgets: Array(12).fill().map(() => ({ life: 15000000, tw: 20000, us: 300 }))
        };

        function bindFmt(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            input.addEventListener('input', (e) => {
                const v = e.target.value;
                display.innerText = v ? parseFloat(v).toLocaleString() : '0';
            });
        }

        function init() {
            document.getElementById('entry-date').valueAsDate = new Date();
            bindFmt('amt', 'fmt-amt');
            bindFmt('in-life', 'fmt-in-life');
            bindFmt('in-tw', 'fmt-in-tw');
            bindFmt('in-us', 'fmt-in-us');
            renderCats();
            refreshAllData();
        }

        function go(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(nb => nb.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.getElementById('nav-'+p).classList.add('active');
            refreshAllData();
        }

        function refreshAllData() {
            renderHome();
            renderChartPage();
            renderMatrix();
        }

        function renderCats() {
            document.getElementById('cat-grid').innerHTML = CATS.map(c => `
                <button onclick="selCat='${c}';renderCats();" class="py-4 rounded-2xl bg-zinc-800/60 text-xs font-bold text-zinc-400 ${selCat===c?'cat-active':''}">
                    ${c}
                </button>
            `).join('');
        }

        function renderHome() {
            const m = new Date().getMonth();
            const thisM = state.records.filter(r => new Date(r.d).getMonth() === m);
            const spent = thisM.filter(r => !['台股','美股'].includes(r.c) && r.cur==='VND').reduce((a,b)=>a+b.v, 0);
            document.getElementById('home-balance').innerText = (state.budgets[m].life - spent).toLocaleString();
            document.getElementById('home-tw').innerText = Math.max(0, state.budgets[m].tw - thisM.filter(r => r.c==='台股').reduce((a,b)=>a+b.v, 0)).toLocaleString();
            document.getElementById('home-us').innerText = Math.max(0, state.budgets[m].us - thisM.filter(r => r.c==='美股').reduce((a,b)=>a+b.v, 0)).toLocaleString();
        }

        function handleAdd() {
            const v = parseFloat(document.getElementById('amt').value);
            if(!v) return;
            state.records.push({ id: Date.now(), v, c: selCat, cur: document.getElementById('cur').value, n: document.getElementById('note').value, d: document.getElementById('entry-date').value });
            save();
            document.getElementById('amt').value = '';
            document.getElementById('fmt-amt').innerText = '0';
            document.getElementById('note').value = '';
            refreshAllData();
            // 不顯示 Alert，增加流暢感
        }

        function renderChartPage() {
            document.getElementById('month-picker').innerHTML = Array(12).fill().map((_, i) => `
                <div onclick="viewM=${i};renderChartPage();" class="month-chip ${viewM===i?'active':''}">${i+1}月</div>
            `).join('');

            const mData = state.records.filter(r => new Date(r.d).getMonth() === viewM);
            const lifeD = mData.filter(r => !['台股','美股'].includes(r.c));
            const total = lifeD.reduce((a,b)=>a+b.v, 0);
            document.getElementById('month-total').innerText = total.toLocaleString();

            const sum = {};
            lifeD.forEach(r => sum[r.c] = (sum[r.c]||0) + r.v);

            // 顯示佔比列表
            document.getElementById('cat-ratios').innerHTML = Object.keys(sum).map(c => `
                <div class="bg-zinc-900 p-3 rounded-xl border border-white/5 flex justify-between">
                    <span class="text-zinc-500">${c}</span>
                    <span class="font-bold text-blue-400">${((sum[c]/total)*100).toFixed(1)}%</span>
                </div>
            `).join('');

            const ctx = document.getElementById('mainChart');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sum),
                    datasets: [{ data: Object.values(sum), backgroundColor: ['#0a84ff', '#5e5ce6', '#64d2ff', '#30d158', '#ff9f0a', '#ff453a', '#bf5af2', '#8e8e93'], borderWidth: 0 }]
                },
                options: { maintainAspectRatio: false, cutout: '80%', plugins: { legend: { display: false } } }
            });

            document.getElementById('history-list').innerHTML = mData.slice().reverse().map(r => `
                <div class="glass-card p-5 flex justify-between items-center" onclick="del(${r.id})">
                    <div><p class="font-bold text-lg text-white">${r.c}</p><p class="text-xs text-zinc-500 mt-1">${r.d} ${r.n?'· '+r.n:''}</p></div>
                    <div class="text-right"><p class="font-bold text-white text-lg">${r.v.toLocaleString()}</p><p class="text-[10px] font-bold text-zinc-600">${r.cur}</p></div>
                </div>
            `).join('');
        }

        function del(id) { if(confirm('刪除？')) { state.records = state.records.filter(r => r.id !== id); save(); refreshAllData(); } }

        function renderMatrix() {
            document.getElementById('matrix-grid').innerHTML = state.budgets.map((b, i) => `
                <div onclick="openEdit(${i})" class="bg-zinc-900 p-4 rounded-2xl text-center border-2 ${editM===i?'border-blue-500':'border-transparent'}">
                    <p class="text-[10px] text-zinc-500 font-bold mb-1">${i+1}月</p>
                    <p class="text-sm font-black text-zinc-300">${(b.life/1000000).toFixed(1)}M</p>
                </div>
            `).join('');
        }

        function openEdit(i) {
            editM = i;
            document.getElementById('edit-box').classList.remove('hidden');
            document.getElementById('edit-title').innerText = `${i+1}月預算編輯`;
            document.getElementById('in-life').value = state.budgets[i].life;
            document.getElementById('fmt-in-life').innerText = state.budgets[i].life.toLocaleString();
            document.getElementById('in-tw').value = state.budgets[i].tw;
            document.getElementById('fmt-in-tw').innerText = state.budgets[i].tw.toLocaleString();
            document.getElementById('in-us').value = state.budgets[i].us;
            document.getElementById('fmt-in-us').innerText = state.budgets[i].us.toLocaleString();
            renderMatrix();
        }

        function saveBudget() {
            state.budgets[editM] = { life: parseFloat(document.getElementById('in-life').value), tw: parseFloat(document.getElementById('in-tw').value), us: parseFloat(document.getElementById('in-us').value) };
            save(); document.getElementById('edit-box').classList.add('hidden'); refreshAllData();
        }

        function save() { localStorage.setItem('fin_v10', JSON.stringify(state)); }
        function exportData() {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Finance_Backup.json`; a.click();
        }

        init();
    </script>
</body>
</html>
