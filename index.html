<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FinanceFlow Ultra v9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --m-bg: #000000; --m-card: #1c1c1e; --m-blue: #0a84ff; }
        body { background-color: var(--m-bg); color: white; font-family: -apple-system, sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
        
        /* 隱藏數字輸入框原生樣式 */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .page { display: none; height: 100vh; overflow-y: auto; padding-bottom: env(safe-area-inset-bottom); -webkit-overflow-scrolling: touch; }
        .page.active { display: block; }

        /* iPhone 質感卡片 */
        .glass-card { background: var(--m-card); border-radius: 28px; border: 0.5px solid rgba(255,255,255,0.1); }
        
        /* 導航列 */
        .nav-bar { 
            background: rgba(20, 20, 22, 0.85); 
            backdrop-filter: saturate(180%) blur(20px); 
            border-top: 0.5px solid rgba(255,255,255,0.1);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { color: #8e8e93; }
        .nav-btn.active { color: var(--m-blue); transform: scale(1.1); }

        /* 金額輸入視覺優化 */
        #formatted-amt { pointer-events: none; transition: all 0.1s; }
        
        /* 莫蘭迪按鈕 */
        .btn-action { 
            background: linear-gradient(145deg, #2c2c2e, #1a1a1c); 
            border: 1px solid rgba(255,255,255,0.15);
            color: #efeff4;
            box-shadow: 0 12px 24px rgba(0,0,0,0.5);
        }
        .btn-action:active { transform: scale(0.96); opacity: 0.8; }

        .cat-active { background: var(--m-blue) !important; color: #fff !important; font-weight: bold; }
        .month-chip { flex: 0 0 auto; padding: 10px 20px; border-radius: 14px; background: #2c2c2e; color: #8e8e93; }
        .month-chip.active { background: #3a3a3c; color: #fff; }
        
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <section id="page-add" class="page active px-6">
        <header class="mb-6 pt-12">
            <p class="text-zinc-500 text-[11px] font-bold tracking-widest uppercase mb-1">Current Balance (VND)</p>
            <h1 class="text-6xl font-black tracking-tighter" id="home-balance">0</h1>
            <div class="flex gap-3 mt-6">
                <div class="flex-1 bg-zinc-900/80 p-4 rounded-3xl border border-white/5">
                    <p class="text-[10px] text-zinc-500 font-bold mb-1">台股待投</p>
                    <p class="text-lg font-bold text-blue-400" id="home-tw">0</p>
                </div>
                <div class="flex-1 bg-zinc-900/80 p-4 rounded-3xl border border-white/5">
                    <p class="text-[10px] text-zinc-500 font-bold mb-1">美股待投</p>
                    <p class="text-lg font-bold text-indigo-400" id="home-us">0</p>
                </div>
            </div>
        </header>

        <div class="glass-card p-6 space-y-8 mb-4">
            <div class="relative h-24 border-b border-zinc-800">
                <div id="formatted-amt" class="absolute inset-0 flex items-center text-7xl font-bold text-white overflow-hidden">0</div>
                <input type="number" id="amt" class="absolute inset-0 w-full bg-transparent text-7xl font-bold opacity-0 focus:outline-none" inputmode="decimal">
                <select id="cur" class="absolute right-0 bottom-4 bg-zinc-800 text-xs font-black px-3 py-1 rounded-full border border-zinc-700">
                    <option value="VND">VND</option>
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div class="grid grid-cols-4 gap-2" id="cat-grid"></div>

            <div class="space-y-4">
                <input type="date" id="entry-date" class="w-full bg-zinc-800/40 p-5 rounded-2xl text-lg outline-none border border-white/5 text-white">
                <input type="text" id="note" placeholder="備註..." class="w-full bg-zinc-800/40 p-5 rounded-2xl text-lg outline-none border border-white/5 text-white">
            </div>

            <button onclick="handleAdd()" class="w-full btn-action py-6 rounded-[24px] font-bold text-xl">
                確認紀錄
            </button>

            <div class="h-32 w-full"></div>
        </div>
    </section>

    <section id="page-chart" class="page px-6">
        <h2 class="text-3xl font-bold mb-6 pt-12">數據分析</h2>
        <div class="flex overflow-x-auto gap-3 mb-6 no-scrollbar" id="month-picker"></div>
        <div class="glass-card p-6 mb-8">
            <div style="height: 280px;"><canvas id="mainChart"></canvas></div>
        </div>
        <div id="history-list" class="space-y-4 pb-40"></div>
    </section>

    <section id="page-set" class="page px-6">
        <h2 class="text-3xl font-bold mb-8 pt-12">年度預算</h2>
        <div class="grid grid-cols-4 gap-3 mb-10" id="matrix-grid"></div>
        <div id="edit-box" class="glass-card p-8 hidden mb-10">
            <h3 class="font-bold text-blue-400 mb-6 text-sm" id="edit-title text-sm">SETTING</h3>
            <div class="space-y-6">
                <input type="number" id="in-life" placeholder="生活費 VND" class="w-full bg-zinc-800 p-5 rounded-2xl text-xl font-bold outline-none">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="in-tw" placeholder="台股 TWD" class="w-full bg-zinc-800 p-5 rounded-2xl text-xl font-bold outline-none">
                    <input type="number" id="in-us" placeholder="美股 USD" class="w-full bg-zinc-800 p-5 rounded-2xl text-xl font-bold outline-none">
                </div>
                <button onclick="saveBudget()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black">SAVE</button>
            </div>
        </div>
        <div class="h-40"></div>
    </section>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 h-24 flex justify-around items-center px-12 z-[100]">
        <button onclick="go('add')" id="nav-add" class="nav-btn active text-3xl"><i class="fa-solid fa-plus-circle"></i></button>
        <button onclick="go('chart')" id="nav-chart" class="nav-btn text-3xl"><i class="fa-solid fa-chart-pie"></i></button>
        <button onclick="go('set')" id="nav-set" class="nav-btn text-3xl"><i class="fa-solid fa-sliders"></i></button>
    </nav>

    <script>
        const CATS = ['飲食', '交通', '購物', '娛樂', '住宿', '台股', '美股', '其他'];
        let selCat = CATS[0];
        let viewM = new Date().getMonth();
        let editM = null;
        let chartObj = null;

        let state = JSON.parse(localStorage.getItem('fin_v9')) || {
            records: [],
            budgets: Array(12).fill().map(() => ({ life: 15000000, tw: 20000, us: 300 }))
        };

        function init() {
            document.getElementById('entry-date').valueAsDate = new Date();
            
            // 金額千分位顯示邏輯
            const amtInput = document.getElementById('amt');
            const amtDisplay = document.getElementById('formatted-amt');
            amtInput.addEventListener('input', (e) => {
                const val = e.target.value;
                amtDisplay.innerText = val ? parseFloat(val).toLocaleString() : '0';
            });

            renderCats();
            refreshAllData();
            go('add');
        }

        function go(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(nb => nb.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active');
            document.getElementById('nav-'+p).classList.add('active');
            refreshAllData();
        }

        function refreshAllData() {
            renderHome();
            renderChartPage();
            renderMatrix();
        }

        function renderCats() {
            document.getElementById('cat-grid').innerHTML = CATS.map(c => `
                <button onclick="selCat='${c}';renderCats();" class="py-4 rounded-2xl bg-zinc-800/60 text-xs font-bold text-zinc-400 ${selCat===c?'cat-active':''}">
                    ${c}
                </button>
            `).join('');
        }

        function renderHome() {
            const m = new Date().getMonth();
            const y = new Date().getFullYear();
            const thisM = state.records.filter(r => {
                const d = new Date(r.d);
                return d.getMonth() === m && d.getFullYear() === y;
            });
            const spent = thisM.filter(r => !['台股','美股'].includes(r.c) && r.cur==='VND').reduce((a,b)=>a+b.v, 0);
            document.getElementById('home-balance').innerText = (state.budgets[m].life - spent).toLocaleString();
            
            const stw = thisM.filter(r => r.c==='台股').reduce((a,b)=>a+b.v, 0);
            const sus = thisM.filter(r => r.c==='美股').reduce((a,b)=>a+b.v, 0);
            document.getElementById('home-tw').innerText = Math.max(0, state.budgets[m].tw - stw).toLocaleString();
            document.getElementById('home-us').innerText = Math.max(0, state.budgets[m].us - sus).toLocaleString();
        }

        function handleAdd() {
            const v = parseFloat(document.getElementById('amt').value);
            if(!v) return;
            state.records.push({
                id: Date.now(), v, c: selCat,
                cur: document.getElementById('cur').value,
                n: document.getElementById('note').value,
                d: document.getElementById('entry-date').value
            });
            save();
            document.getElementById('amt').value = '';
            document.getElementById('formatted-amt').innerText = '0';
            document.getElementById('note').value = '';
            refreshAllData();
            alert('DONE');
        }

        function renderChartPage() {
            document.getElementById('month-picker').innerHTML = Array(12).fill().map((_, i) => `
                <div onclick="viewM=${i};renderChartPage();" class="month-chip ${viewM===i?'active':''}">${i+1}月</div>
            `).join('');

            const mData = state.records.filter(r => new Date(r.d).getMonth() === viewM);
            const lifeD = mData.filter(r => !['台股','美股'].includes(r.c));
            const sum = {};
            lifeD.forEach(r => sum[r.c] = (sum[r.c]||0) + r.v);

            const ctx = document.getElementById('mainChart');
            if(chartObj) chartObj.destroy();
            chartObj = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(sum),
                    datasets: [{
                        data: Object.values(sum),
                        backgroundColor: ['#0a84ff', '#5e5ce6', '#64d2ff', '#30d158', '#ff9f0a', '#ff453a', '#bf5af2', '#8e8e93'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    maintainAspectRatio: false,
                    cutout: '80%', 
                    plugins: { legend: { position: 'bottom', labels: { color: '#8e8e93', font: { size: 12, weight: 'bold' } } } } 
                }
            });

            document.getElementById('history-list').innerHTML = mData.slice().reverse().map(r => `
                <div class="glass-card p-5 flex justify-between items-center" onclick="del(${r.id})">
                    <div>
                        <p class="font-bold text-lg text-white">${r.c}</p>
                        <p class="text-xs text-zinc-500 mt-1">${r.d} ${r.n?'· '+r.n:''}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-white text-lg">${r.v.toLocaleString()}</p>
                        <p class="text-[10px] font-bold text-zinc-600">${r.cur}</p>
                    </div>
                </div>
            `).join('');
        }

        function del(id) {
            if(confirm('Delete?')) {
                state.records = state.records.filter(r => r.id !== id);
                save();
                refreshAllData();
            }
        }

        function renderMatrix() {
            document.getElementById('matrix-grid').innerHTML = state.budgets.map((b, i) => `
                <div onclick="openEdit(${i})" class="bg-zinc-900 p-4 rounded-2xl text-center border-2 ${editM===i?'border-blue-500':'border-transparent'}">
                    <p class="text-[11px] text-zinc-500 font-bold mb-1">${i+1}月</p>
                    <p class="text-sm font-black text-zinc-300">${(b.life/1000000).toFixed(1)}M</p>
                </div>
            `).join('');
        }

        function openEdit(i) {
            editM = i;
            document.getElementById('edit-box').classList.remove('hidden');
            document.getElementById('edit-title').innerText = `${i+1}月預算編輯`;
            document.getElementById('in-life').value = state.budgets[i].life;
            document.getElementById('in-tw').value = state.budgets[i].tw;
            document.getElementById('in-us').value = state.budgets[i].us;
            renderMatrix();
        }

        function saveBudget() {
            state.budgets[editM] = {
                life: parseFloat(document.getElementById('in-life').value),
                tw: parseFloat(document.getElementById('in-tw').value),
                us: parseFloat(document.getElementById('in-us').value)
            };
            save();
            document.getElementById('edit-box').classList.add('hidden');
            refreshAllData();
        }

        function save() { localStorage.setItem('fin_v9', JSON.stringify(state)); }

        init();
    </script>
</body>
</html>
